<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weekly Calendar Planner</title>
<style>
  * { box-sizing: border-box; }
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f0f2f5;
  }
  h1 {
    text-align: center;
    padding: 15px;
    background: #1976d2;
    color: white;
    margin: 0;
  }
  #controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 15px 0;
  }
  #controls button {
    padding: 8px 15px;
    border: none;
    background: #1976d2;
    color: white;
    border-radius: 5px;
    cursor: pointer;
  }
  #calendar {
    display: grid;
    grid-template-columns: 60px repeat(7, 1fr);
    border: 1px solid #ccc;
    max-width: 1200px;
    margin: 0 auto 40px;
    background: white;
    position: relative;
  }
  #timeLabels {
    grid-column: 1 / 2;
    background: #fafafa;
    border-right: 1px solid #ccc;
  }
  .timeLabel {
    height: 60px;
    font-size: 12px;
    text-align: right;
    padding-right: 5px;
    line-height: 60px;
    color: #666;
    border-bottom: 1px solid #eee;
  }
  .dayColumn {
    position: relative;
    border-left: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
    background: #fff;
  }
  .dayHeader {
    height: 30px;
    line-height: 30px;
    text-align: center;
    background: #1976d2;
    color: white;
    font-weight: bold;
    border-bottom: 1px solid #ccc;
  }
  .hourLine {
    position: absolute;
    left: 0;
    right: 0;
    height: 1px;
    background: #eee;
  }
  .task {
    position: absolute;
    left: 5px;
    right: 5px;
    border-radius: 5px;
    padding: 3px 5px;
    font-size: 12px;
    color: white;
    cursor: pointer;
    overflow: hidden;
    border: 1px solid transparent;
  }
  .task:hover { border-color: #00000050; }
  .class { background: #4caf50; }
  .assignment { background: #ff9800; }
  .exam { background: #f44336; }
  .event { background: #2196f3; }

  /* Current time line */
  #currentTimeLine::after {
  content: attr(data-time);
  position: absolute;
  top: -14px;
  left: 5px;
  background: #2196f3;
  color: white;
  font-size: 11px;
  padding: 2px 5px;
  border-radius: 3px;
  white-space: nowrap;
}
  /* Modal */
  #overlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    display: none;
    z-index: 1000;
  }
  #taskModal {
    position: fixed;
    top: 50%; left: 50%;
    width: 320px;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    transform: translate(-50%, -50%);
    z-index: 1100;
    display: none;
  }
  #taskModal label { display: block; margin-top: 10px; font-weight: 600; }
  #taskModal input, #taskModal select {
    width: 100%; padding: 6px; margin-top: 4px;
    border: 1px solid #ccc; border-radius: 4px;
  }
  #weekdaySelector { margin-top: 8px; }
  #weekdaySelector label { margin-right: 8px; cursor: pointer; }
  button {
    cursor: pointer; padding: 10px; margin-top: 15px; width: 100%;
    border: none; border-radius: 5px; font-weight: bold;
  }
  button.saveBtn { background: #1976d2; color: white; }
  button.cancelBtn { background: #999; color: white; margin-top: 8px; }
  button.deleteBtn { background: #f44336; color: white; margin-top: 8px; }
</style>
</head>
<body>

<h1>📅 Weekly Calendar Planner</h1>
<div id="controls">
  <button onclick="prevWeek()">◀ Previous</button>
  <button onclick="goToday()">Today</button>
  <button onclick="nextWeek()">Next ▶</button>
</div>

<div id="calendar">
  <div id="timeLabels"></div>
  <!-- Days generated by JS -->
  <div id="currentTimeLine"></div>
</div>

<div id="overlay"></div>
<div id="taskModal">
  <h2 id="modalTitle">Add Task</h2>
  <label>Task Name:</label>
  <input type="text" id="taskName" />

  <label>Date:</label>
  <input type="date" id="taskDate" />

  <label>Start Time:</label>
  <input type="time" id="startTime" />

  <label>End Time:</label>
  <input type="time" id="endTime" />

  <label>Location:</label>
  <input type="text" id="taskLocation" />

  <label>Type:</label>
  <select id="taskType">
    <option value="class">Class</option>
    <option value="assignment">Assignment</option>
    <option value="exam">Exam</option>
    <option value="event">Event</option>
  </select>

  <label>Recurrence:</label>
  <select id="recurrence" onchange="toggleWeekdays()">
    <option value="none">None</option>
    <option value="daily">Daily</option>
    <option value="weekly">Weekly</option>
    <option value="custom">Custom Days</option>
    <option value="eightdays">Every 8 Days</option>
  </select>

  <div id="weekdaySelector" style="display:none;">
    <label><input type="checkbox" value="0" /> Sun</label>
    <label><input type="checkbox" value="1" /> Mon</label>
    <label><input type="checkbox" value="2" /> Tue</label>
    <label><input type="checkbox" value="3" /> Wed</label>
    <label><input type="checkbox" value="4" /> Thu</label>
    <label><input type="checkbox" value="5" /> Fri</label>
    <label><input type="checkbox" value="6" /> Sat</label>
  </div>

  <button class="saveBtn" onclick="saveTask()">Save</button>
  <button class="cancelBtn" onclick="closeModal()">Cancel</button>
  <button class="deleteBtn" id="deleteBtn" onclick="deleteTask()">Delete</button>
</div>

<script>
let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
let editingTaskId = null;
let currentDate = new Date();
currentDate.setHours(0,0,0,0);
let weekStart = getWeekStart(currentDate);

const calendar = document.getElementById("calendar");
const timeLabels = document.getElementById("timeLabels");
const overlay = document.getElementById("overlay");
const taskModal = document.getElementById("taskModal");
const modalTitle = document.getElementById("modalTitle");
const deleteBtn = document.getElementById("deleteBtn");

function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  d.setDate(d.getDate() - day);
  return d;
}
function formatDate(date) {
  return date.toISOString().slice(0,10);
}
function generateTimeLabels() {
  timeLabels.innerHTML = "";
  for (let h=0; h<24; h++) {
    const div = document.createElement("div");
    div.className = "timeLabel";
    div.innerText = `${String(h).padStart(2,"0")}:00`;
    timeLabels.appendChild(div);
  }
}
function generateDayColumns() {
  document.querySelectorAll(".dayColumn").forEach(e=>e.remove());
  for (let i=0; i<7; i++) {
    const dayDate = new Date(weekStart);
    dayDate.setDate(dayDate.getDate() + i);
    const col = document.createElement("div");
    col.className="dayColumn";
    col.dataset.date=formatDate(dayDate);
    const head=document.createElement("div");
    head.className="dayHeader";
    head.innerText=dayDate.toDateString().slice(0,10);
    col.appendChild(head);
    for (let h=0; h<24; h++) {
      const line=document.createElement("div");
      line.className="hourLine";
      line.style.top=`${30+h*60}px`;
      col.appendChild(line);
    }
    col.addEventListener("click",e=>{
      if (e.target===col || e.target.classList.contains("hourLine")|| e.target.classList.contains("dayHeader")){
        openModal({date:col.dataset.date});
      }
    });
    calendar.appendChild(col);
  }
}
function renderTasks() {
  document.querySelectorAll(".task").forEach(t=>t.remove());
  const dayColumns=document.querySelectorAll(".dayColumn");
  dayColumns.forEach(dayCol=>{
    const dateStr=dayCol.dataset.date;
    const dayDate=new Date(dateStr);
    tasks.forEach(task=>{
      if (!shouldShowTask(task, dayDate)) return;
      const start=parseTime(task.startTime);
      const end=parseTime(task.endTime);
      const dur=(end.hour*60+end.minute)-(start.hour*60+start.minute);
      if (dur<=0) return;
      const top=30+start.hour*60+start.minute;
      const div=document.createElement("div");
      div.className=`task ${task.type}`;
      div.style.top=`${top}px`;
      div.style.height=`${dur}px`;
      div.innerText=task.name;
      div.title=`${task.name}\n${task.startTime}-${task.endTime}`;
      div.onclick=e=>{e.stopPropagation();openModal(task)};
      dayCol.appendChild(div);
    });
  });
}
function shouldShowTask(task,dateObj){
  const tDate=new Date(task.date);
  if (task.recurrence==="none") return formatDate(dateObj)===formatDate(tDate);
  if (task.recurrence==="daily") return dateObj>=tDate;
  if (task.recurrence==="weekly") return dateObj>=tDate && dateObj.getDay()===tDate.getDay();
  if (task.recurrence==="custom") return dateObj>=tDate && task.weekdays.includes(dateObj.getDay());
  if (task.recurrence==="eightdays"){
    if (dateObj<tDate) return false;
    const diff=Math.floor((dateObj-tDate)/(1000*60*60*24));
    return diff%8===0;
  }
  return false;
}
function parseTime(t){
  const [h,m]=t.split(":");
  return {hour:+h,minute:+m};
}
function openModal(task=null){
  overlay.style.display="block"; taskModal.style.display="block";
  editingTaskId=null; deleteBtn.style.display="none"; modalTitle.innerText="Add Task";
  document.getElementById("taskName").value="";
  document.getElementById("taskDate").value=formatDate(currentDate);
  document.getElementById("startTime").value="09:00";
  document.getElementById("endTime").value="10:00";
  document.getElementById("taskLocation").value="";
  document.getElementById("taskType").value="class";
  document.getElementById("recurrence").value="none";
  toggleWeekdays();
  document.querySelectorAll("#weekdaySelector input").forEach(cb=>cb.checked=false);
  if (task && task.id){
    editingTaskId=task.id; modalTitle.innerText="Edit Task"; deleteBtn.style.display="block";
    document.getElementById("taskName").value=task.name;
    document.getElementById("taskDate").value=task.date;
    document.getElementById("startTime").value=task.startTime;
    document.getElementById("endTime").value=task.endTime;
    document.getElementById("taskLocation").value=task.location;
    document.getElementById("taskType").value=task.type;
    document.getElementById("recurrence").value=task.recurrence;
    toggleWeekdays();
    if (task.recurrence==="custom" && task.weekdays){
      document.querySelectorAll("#weekdaySelector input").forEach(cb=>{
        cb.checked=task.weekdays.includes(+cb.value);
      });
    }
  }
}
function closeModal(){ overlay.style.display="none"; taskModal.style.display="none"; editingTaskId=null; }
function saveTask(){
  const name=document.getElementById("taskName").value.trim();
  const date=document.getElementById("taskDate").value;
  const start=document.getElementById("startTime").value;
  const end=document.getElementById("endTime").value;
  if(!name||!date||!start||!end){alert("Fill all required fields");return;}
  if(start>=end){alert("End time must be after start");return;}
  const location=document.getElementById("taskLocation").value.trim();
  const type=document.getElementById("taskType").value;
  const recurrence=document.getElementById("recurrence").value;
  let weekdays=[];
  if (recurrence==="custom"){
    weekdays=Array.from(document.querySelectorAll("#weekdaySelector input:checked")).map(cb=>+cb.value);
    if (weekdays.length===0){alert("Select weekdays");return;}
  }
  if(editingTaskId){
    const idx=tasks.findIndex(t=>t.id===editingTaskId);
    if(idx!==-1) tasks[idx]={...tasks[idx],name,date,startTime:start,endTime:end,location,type,recurrence,weekdays};
  }else{
    tasks.push({id:Date.now(),name,date,startTime:start,endTime:end,location,type,recurrence,weekdays});
  }
  saveTasks(); closeModal(); renderTasks();
}
function deleteTask(){
  if(editingTaskId && confirm("Delete task?")){
    tasks=tasks.filter(t=>t.id!==editingTaskId);
    saveTasks(); closeModal(); renderTasks();
  }
}
function saveTasks(){ localStorage.setItem("tasks",JSON.stringify(tasks)); }
function toggleWeekdays(){
  document.getElementById("weekdaySelector").style.display=
    document.getElementById("recurrence").value==="custom"?"block":"none";
}
function updateCurrentTimeLine(){
  const line = document.getElementById("currentTimeLine");
  const now = new Date();
  const startOfWeek = new Date(weekStart);
  const endOfWeek = new Date(weekStart); 
  endOfWeek.setDate(endOfWeek.getDate()+6);

  if (now < startOfWeek || now > endOfWeek) {
    line.style.display = "none";
    return;
  }

  line.style.display = "block";

  // calculate position
  const minutes = now.getHours()*60 + now.getMinutes();
  const top = 30 + minutes + (now.getSeconds() / 60); // include seconds fraction
  line.style.top = `${top}px`;

  // show time text (HH:MM:SS)
  const h = String(now.getHours()).padStart(2,"0");
  const m = String(now.getMinutes()).padStart(2,"0");
  const s = String(now.getSeconds()).padStart(2,"0");
  line.setAttribute("data-time", `${h}:${m}:${s}`);
// Request notification permission
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

// Check for upcoming tasks every second
setInterval(() => {
  if (!("Notification" in window) || Notification.permission !== "granted") return;
  
  const now = new Date();
  const nowStr = `${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
  
  tasks.forEach(task => {
    if (task.date === formatDate(now)) {
      // if it's the task start time
      if (task.startTime === nowStr && now.getSeconds() === 0) {
        new Notification("⏰ Task Reminder", {
          body: `${task.name} at ${task.startTime} (${task.location || "No location"})`,
          icon: "https://cdn-icons-png.flaticon.com/512/2088/2088617.png"
        });
      }
    }
  });
}, 1000);

  // adjust width/position for the correct day column
  const dayIndex = now.getDay();
  const cols = document.querySelectorAll(".dayColumn");
  if (cols.length === 7) {
    const col = cols[dayIndex];
    line.style.left = `${col.offsetLeft}px`;
    line.style.width = `${col.offsetWidth}px`;
  }
}
function init(){
  generateTimeLabels(); generateDayColumns(); renderTasks(); updateCurrentTimeLine();
  setInterval(updateCurrentTimeLine,1000);
}
function prevWeek(){ weekStart.setDate(weekStart.getDate()-7); generateDayColumns(); renderTasks(); }
function nextWeek(){ weekStart.setDate(weekStart.getDate()+7); generateDayColumns(); renderTasks(); }
function goToday(){ currentDate=new Date(); currentDate.setHours(0,0,0,0); weekStart=getWeekStart(currentDate); generateDayColumns(); renderTasks(); }

overlay.addEventListener("click",closeModal);
init();
</script>
</body>
</html>
