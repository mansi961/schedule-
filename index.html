<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ðŸ“… Weekly College Planner with Recurrence & Delete</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { text-align: center; }
  #weekNav { text-align: center; margin-bottom: 10px; }
  #weekNav button { padding: 5px 10px; margin: 0 5px; cursor: pointer; }
  #weekContainer {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
  }
  .dayColumn { border: 1px solid #ccc; background: #f9f9f9; position: relative; }
  .dayHeader {
    background: #eee;
    font-weight: bold;
    padding: 5px;
    text-align: center;
    user-select: none;
  }
  .hourRow {
    border-top: 1px solid #ddd;
    min-height: 40px;
    position: relative;
    cursor: pointer;
    padding: 0 3px;
  }
  .hourLabel {
    font-size: 10px;
    position: absolute;
    left: 3px;
    top: 2px;
    user-select: none;
  }
  .tasks {
    margin-left: 35px;
    position: relative;
    z-index: 2; /* Ensure tasks are above time indicator */
  }
  .task {
    position: relative;
    padding: 2px 5px;
    margin: 1px 0;
    border-radius: 4px;
    font-size: 12px;
    color: white;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    z-index: 3;
  }
  .task:hover {
    opacity: 0.8;
  }
  .class { background: #4CAF50; }
  .assignment { background: #FF9800; }
  .exam { background: #F44336; }
  .event { background: #2196F3; }
  .currentHour {
    background: #ffeb3b !important;
    color: black;
  }
  /* Current Time Line */
  .currentTimeLine {
    position: absolute;
    height: 2px;
    background-color: blue;
    left: 35px; /* align past hour labels */
    right: 5px;
    z-index: 1;
  }

  #taskModal {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border: 1px solid #ccc;
    padding: 20px;
    z-index: 1000;
    width: 320px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
  }
  #overlay {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    z-index: 500;
  }
  #taskModal input,
  #taskModal select {
    display: block;
    margin: 10px 0;
    padding: 6px;
    width: 100%;
    box-sizing: border-box;
  }
  #weekdaySelector label {
    margin-right: 8px;
    user-select: none;
  }
  button.saveBtn {
    margin-top: 10px;
    background: #1976d2;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
  }
  button.cancelBtn {
    margin-top: 8px;
    background: #888;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
  }
</style>
</head>
<body>

<h1>ðŸ“… Weekly College Planner</h1>
<div id="weekNav">
  <button onclick="prevWeek()">âŸ¨ Prev Week</button>
  <span id="weekRange"></span>
  <button onclick="nextWeek()">Next Week âŸ©</button>
</div>

<div id="weekContainer"></div>

<div id="overlay" onclick="closeModal()"></div>

<div id="taskModal">
  <h2>Add Task</h2>
  <label>Task Name:</label>
  <input type="text" id="taskName" placeholder="Task name" />
  
  <label>Start Time:</label>
  <input type="time" id="startTime" />
  
  <label>End Time:</label>
  <input type="time" id="endTime" />
  
  <label>Location:</label>
  <input type="text" id="taskLocation" placeholder="Location" />
  
  <label>Type:</label>
  <select id="taskType">
    <option value="class">Class</option>
    <option value="assignment">Assignment</option>
    <option value="exam">Exam</option>
    <option value="event">Event</option>
  </select>
  
  <label>Recurrence:</label>
  <select id="recurrence" onchange="toggleWeekdays()">
    <option value="none">None</option>
    <option value="daily">Daily</option>
    <option value="weekly">Weekly</option>
    <option value="custom">Custom Days</option>
    <option value="8days">Every 8 Days</option> <!-- New recurrence option -->
  </select>
  
  <div id="weekdaySelector" style="display:none; margin-top: 5px;">
    <label><input type="checkbox" value="0" /> Sun</label>
    <label><input type="checkbox" value="1" /> Mon</label>
    <label><input type="checkbox" value="2" /> Tue</label>
    <label><input type="checkbox" value="3" /> Wed</label>
    <label><input type="checkbox" value="4" /> Thu</label>
    <label><input type="checkbox" value="5" /> Fri</label>
    <label><input type="checkbox" value="6" /> Sat</label>
  </div>
  
  <!-- Save button moved after recurrence selectors -->
  <button class="saveBtn" onclick="saveTask()">Save</button>
  <button class="cancelBtn" onclick="closeModal()">Cancel</button>
</div>

<script>
let weekContainer = document.getElementById("weekContainer");
let taskModal = document.getElementById("taskModal");
let overlay = document.getElementById("overlay");
let weekRangeEl = document.getElementById("weekRange");

let tasks = JSON.parse(localStorage.getItem("tasks")) || [];
let currentDate = new Date();
let selectedDay = null;

function getWeekStart(date) {
  let d = new Date(date);
  let day = d.getDay();
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() - day); // Sunday start
  return d;
}

function formatDate(date) {
  return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

// Build the week view grid
function buildWeek(date) {
  weekContainer.innerHTML = "";
  const startOfWeek = getWeekStart(date);
  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(endOfWeek.getDate() + 6);
  weekRangeEl.innerText = `${startOfWeek.toDateString()} - ${endOfWeek.toDateString()}`;

  for(let d=0; d<7; d++) {
    const dayDate = new Date(startOfWeek);
    dayDate.setDate(dayDate.getDate() + d);
    const dayCol = document.createElement("div");
    dayCol.classList.add("dayColumn");
    dayCol.style.position = "relative";

    const header = document.createElement("div");
    header.classList.add("dayHeader");
    header.innerText = dayDate.toDateString();
    header.setAttribute("data-date", formatDate(dayDate));
    dayCol.appendChild(header);

    for(let hour=0; hour<24; hour++) {
      const hourRow = document.createElement("div");
      hourRow.classList.add("hourRow");
      hourRow.onclick = () => openModal(dayDate);

      const label = document.createElement("div");
      label.classList.add("hourLabel");
      label.innerText = `${String(hour).padStart(2,'0')}:00`;
      hourRow.appendChild(label);

      const taskArea = document.createElement("div");
      taskArea.classList.add("tasks");
      hourRow.appendChild(taskArea);

      dayCol.appendChild(hourRow);
    }

    // Add a container div to position the current time line inside dayColumn
    const timeLine = document.createElement("div");
    timeLine.classList.add("currentTimeLine");
    timeLine.style.display = "none"; // Hidden initially
    dayCol.appendChild(timeLine);

    weekContainer.appendChild(dayCol);
  }

  highlightCurrentHour();
  renderTasks();
  updateCurrentTimeLine(); // Call after building grid
}

// Highlight current day and hour
function highlightCurrentHour() {
  const now = new Date();
  const currentDayStr = now.toDateString();
  const currentHour = now.getHours();

  const dayColumns = document.querySelectorAll(".dayColumn");
  dayColumns.forEach(col => {
    const dayStr = col.querySelector(".dayHeader").innerText;
    const rows = col.querySelectorAll(".hourRow");
    rows.forEach(row => row.classList.remove("currentHour"));
    if(dayStr === currentDayStr) {
      rows.forEach(row => {
        const rowHour = parseInt(row.querySelector(".hourLabel").innerText.split(":")[0]);
        if(rowHour === currentHour) {
          row.classList.add("currentHour");
        }
      });
    }
  });

  // Update every minute
  setTimeout(highlightCurrentHour, 60000);
}

function openModal(day) {
  selectedDay = formatDate(day);
  taskModal.style.display = "block";
  overlay.style.display = "block";

  // Reset form
  clearForm();
}

function closeModal() {
  taskModal.style.display = "none";
  overlay.style.display = "none";
}

function toggleWeekdays() {
  const recurrence = document.getElementById("recurrence").value;
  document.getElementById("weekdaySelector").style.display = (recurrence === "custom") ? "block" : "none";
}

function saveTask() {
  const name = document.getElementById("taskName").value.trim();
  const startTime = document.getElementById("startTime").value;
  const endTime = document.getElementById("endTime").value;
  const location = document.getElementById("taskLocation").value.trim();
  const type = document.getElementById("taskType").value;
  const recurrence = document.getElementById("recurrence").value;

  if (!name || !startTime || !endTime) {
    return alert("Please enter name, start and end time!");
  }
  if (startTime >= endTime) {
    return alert("End time must be after start time.");
  }

  let weekdays = [];
  if (recurrence === "custom") {
    document.querySelectorAll("#weekdaySelector input:checked").forEach(cb => {
      weekdays.push(parseInt(cb.value));
    });
    if (weekdays.length === 0) {
      return alert("Please select at least one weekday for custom recurrence.");
    }
  }

  const task = {
    id: Date.now(),  // Unique ID for deletion
    date: selectedDay,
    name,
    startTime,
    endTime,
    location,
    type,
    recurrence,
    weekdays
  };

  tasks.push(task);
  localStorage.setItem("tasks", JSON.stringify(tasks));

  closeModal();
  buildWeek(currentDate);
}

function clearForm() {
  document.getElementById("taskName").value = "";
  document.getElementById("startTime").value = "";
  document.getElementById("endTime").value = "";
  document.getElementById("taskLocation").value = "";
  document.getElementById("taskType").value = "class";
  document.getElementById("recurrence").value = "none";
  toggleWeekdays();
  document.querySelectorAll("#weekdaySelector input").forEach(cb => cb.checked = false);
}

function renderTasks() {
  const dayColumns = document.querySelectorAll(".dayColumn");
  dayColumns.forEach(col => {
    const dateStr = col.querySelector(".dayHeader").getAttribute("data-date");
    const date = new Date(dateStr);
    const dayOfWeek = date.getDay();

    const rows = col.querySelectorAll(".hourRow");
    rows.forEach(row => {
      const taskArea = row.querySelector(".tasks");
      taskArea.innerHTML = "";

      tasks.forEach(task => {
        let shouldShow = false;

        if (task.date === dateStr) {
          shouldShow = true;
        } else if (task.recurrence === "daily") {
          shouldShow = true;
        } else if (task.recurrence === "weekly") {
          const taskDate = new Date(task.date);
          if (taskDate.getDay() === dayOfWeek) shouldShow = true;
        } else if (task.recurrence === "custom" && task.weekdays.includes(dayOfWeek)) {
          shouldShow = true;
        } else if (task.recurrence === "8days") {
          // Every 8 days from the task date, check if current date matches that pattern
          const taskStartDate = new Date(task.date);
          const diffTime = date - taskStartDate;
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          if (diffDays >= 0 && diffDays % 8 === 0) {
            shouldShow = true;
          }
        }

        if (shouldShow) {
          const rowHour = parseInt(row.querySelector(".hourLabel").innerText.split(":")[0]);
          const taskStartHour = parseInt(task.startTime.split(":")[0]);
          const taskEndHour = parseInt(task.endTime.split(":")[0]);
          if (rowHour >= taskStartHour && rowHour <= taskEndHour) {
            const div = document.createElement("div");
            div.classList.add("task", task.type);
            div.title = `${task.name} @${task.location}\nClick to delete`;
            div.innerText = `${task.startTime}-${task.endTime} ${task.name} @${task.location}`;
            div.onclick = (e) => {
              e.stopPropagation();
              if (confirm(`Delete task: "${task.name}"?`)) {
                deleteTask(task.id);
              }
            };
            taskArea.appendChild(div);
          }
        }
      });
    });
  });
}

function deleteTask(id) {
  tasks = tasks.filter(t => t.id !== id);
  localStorage.setItem("tasks", JSON.stringify(tasks));
  buildWeek(currentDate);
}

function prevWeek() {
  currentDate.setDate(currentDate.getDate() - 7);
  buildWeek(currentDate);
}

function nextWeek() {
  currentDate.setDate(currentDate.getDate() + 7);
  buildWeek(currentDate);
}

// Function to update the blue current time line on each day column
function updateCurrentTimeLine() {
  const now = new Date();
  const startOfWeek = getWeekStart(currentDate);

  // Loop over each day column and position the current time line if today is in that column
  const dayColumns = document.querySelectorAll(".dayColumn");

  dayColumns.forEach(col => {
    const dateStr = col.querySelector(".dayHeader").getAttribute("data-date");
    const colDate = new Date(dateStr);

    const timeLine = col.querySelector(".currentTimeLine");

    if (colDate.toDateString() === now.toDateString()) {
      // Show line
      timeLine.style.display = "block";

      // Calculate position within the column:
      // Each hourRow min-height: 40px, 24 rows = 960px total height approx
      // We calculate the number of minutes & seconds into the day, then convert to pixels

      const hourRowHeight = 40; // px per hour row
      const totalHours = 24;

      // Total minutes in day so far:
      const minutes = now.getHours() * 60 + now.getMinutes() + now.getSeconds()/60;

      // Total pixels from top of dayColumn excluding header height (~30px)
      const headerHeight = col.querySelector(".dayHeader").offsetHeight;
      const offsetY = headerHeight + (minutes / 60) * hourRowHeight;

      timeLine.style.top = `${offsetY}px`;
    } else {
      timeLine.style.display = "none";
    }
  });

  // Update every second to keep seconds accurate
  setTimeout(updateCurrentTimeLine, 1000);
}

// Initial build
buildWeek(currentDate);
</script>

</body>
</html>
